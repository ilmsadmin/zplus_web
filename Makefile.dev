# Makefile for ZPlus Web Backend Development

.PHONY: help dev build run test clean install deps db-only air

# Default target
help:
	@echo "Available commands for development:"
	@echo "  make dev       - Setup development environment and start backend"
	@echo "  make run       - Run backend with go run main.go"
	@echo "  make air       - Run backend with hot reload (air)"
	@echo "  make build     - Build the backend binary"
	@echo "  make test      - Run tests"
	@echo "  make deps      - Install/update dependencies"
	@echo "  make db-only   - Start only database services (PostgreSQL + Redis)"
	@echo "  make clean     - Clean build artifacts"
	@echo "  make install   - Install development tools"

# Setup development environment
dev:
	@echo "ğŸš€ Setting up development environment..."
	@if [ ! -f "backend/.env" ]; then \
		echo "Creating .env file..."; \
		cp backend/.env.example backend/.env; \
	fi
	@mkdir -p backend/logs
	@cd backend && go mod tidy
	@echo "âœ… Development environment ready!"
	@echo "Now you can run: make run or make air"

# Install development dependencies
deps:
	@echo "ğŸ“¦ Installing Go dependencies..."
	@cd backend && go mod download
	@cd backend && go mod tidy

# Install development tools
install:
	@echo "ğŸ”§ Installing development tools..."
	@go install github.com/cosmtrek/air@latest
	@echo "âœ… Development tools installed!"

# Run backend with go run
run: dev
	@echo "ğŸƒ Starting backend with go run..."
	@cd backend && go run main.go

# Run backend with hot reload
air: dev install
	@echo "ğŸ”¥ Starting backend with hot reload..."
	@cd backend && air

# Build the backend binary
build: deps
	@echo "ğŸ”¨ Building backend..."
	@cd backend && go build -o main .
	@echo "âœ… Backend built successfully!"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	@cd backend && go test ./...

# Start only database services
db-only:
	@echo "ğŸ—„ï¸ Starting database services..."
	@docker-compose up -d postgres redis
	@echo "âœ… Database services started!"
	@echo "PostgreSQL: localhost:5432"
	@echo "Redis: localhost:6379"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@cd backend && rm -f main
	@cd backend && rm -rf tmp/
	@cd backend && rm -f build-errors.log
	@echo "âœ… Clean completed!"

# Check if database services are running
check-db:
	@echo "ğŸ” Checking database services..."
	@if pg_isready -h localhost -p 5432 -U postgres > /dev/null 2>&1; then \
		echo "âœ… PostgreSQL is running"; \
	else \
		echo "âŒ PostgreSQL is not running"; \
		echo "ğŸ’¡ Run: make db-only"; \
	fi
	@if redis-cli -h localhost -p 6379 ping > /dev/null 2>&1; then \
		echo "âœ… Redis is running"; \
	else \
		echo "âŒ Redis is not running"; \
		echo "ğŸ’¡ Run: make db-only"; \
	fi

# Stop database services
stop-db:
	@echo "ğŸ›‘ Stopping database services..."
	@docker-compose stop postgres redis

# View database logs
db-logs:
	@docker-compose logs -f postgres redis
